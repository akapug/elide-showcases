# Elide Configuration for Fastify
#
# This configuration enables polyglot features and optimizations
# for running Fastify on the Elide runtime.

version: "1.0"

# Project metadata
project:
  name: "fastify-on-elide"
  description: "Fastify web framework with polyglot superpowers"
  version: "1.0.0"

# Runtime configuration
runtime:
  # Enable polyglot support for cross-language integration
  polyglot:
    enabled: true
    languages:
      - javascript
      - typescript
      - python
      - ruby

  # Performance optimizations
  optimization:
    level: "O3"  # Maximum optimization
    jit:
      enabled: true
      threshold: 1000  # JIT compile after 1000 invocations

    # GraalVM compiler options
    compiler:
      # Enable aggressive optimizations
      aggressive: true
      # Enable partial escape analysis
      partial_escape_analysis: true
      # Enable loop unrolling
      loop_unrolling: true

  # Native image configuration (for building standalone executables)
  native_image:
    enabled: true
    build_options:
      # Optimize for size or speed
      optimize_for: "speed"  # or "size"
      # Enable static linking
      static: false
      # Include debug symbols
      debug_symbols: false
      # Quick build mode (faster builds, less optimization)
      quick_build: false

    # Resources to include in native image
    resources:
      include:
        - "src/**/*.ts"
        - "examples/**/*.ts"

    # Reflection configuration
    reflection:
      # Auto-detect reflection usage
      auto_detect: true
      # Additional classes requiring reflection
      additional_classes: []

    # JNI configuration
    jni:
      enabled: false

# HTTP server configuration
server:
  # Default port
  port: 3000
  # Default host
  host: "0.0.0.0"
  # Request timeout (ms)
  timeout: 30000
  # Body size limit (bytes)
  body_limit: 10485760  # 10MB
  # Keep-alive timeout (ms)
  keep_alive_timeout: 5000

# Logging configuration
logging:
  # Log level: trace, debug, info, warn, error
  level: "info"
  # Pretty print logs (disable in production)
  pretty: true
  # Log to file
  file:
    enabled: false
    path: "./logs/fastify.log"
    rotation:
      max_size: "10mb"
      max_files: 5

# Python configuration (for polyglot features)
python:
  # Python version
  version: "3.11"
  # Virtual environment
  venv:
    enabled: false
    path: "./.venv"
  # Python packages to install
  packages:
    - "numpy>=1.24.0"
    - "scipy>=1.10.0"
    - "scikit-learn>=1.3.0"
  # Python path additions
  path:
    - "./python_modules"

# Ruby configuration (for polyglot features)
ruby:
  # Ruby version
  version: "3.2"
  # Gems to install
  gems:
    - "activesupport"
    - "concurrent-ruby"
  # Gem path additions
  path:
    - "./ruby_modules"

# Development configuration
development:
  # Hot reload
  hot_reload:
    enabled: true
    watch:
      - "src/**/*.ts"
      - "examples/**/*.ts"
  # Auto-restart on crash
  auto_restart: true
  # Source maps
  source_maps: true

# Production configuration
production:
  # Disable hot reload
  hot_reload:
    enabled: false
  # Enable all optimizations
  optimization:
    level: "O3"
  # Disable pretty logging
  logging:
    pretty: false
  # Enable compression
  compression:
    enabled: true
    level: 6

# Testing configuration
testing:
  # Test framework
  framework: "jest"
  # Coverage threshold
  coverage:
    threshold: 80
  # Parallel test execution
  parallel: true
  # Test timeout (ms)
  timeout: 10000

# Build configuration
build:
  # Output directory
  output_dir: "./dist"
  # Source directory
  source_dir: "./src"
  # Include source maps
  source_maps: true
  # Minify output
  minify: false
  # Tree shaking
  tree_shake: true
  # External dependencies (not bundled)
  externals:
    - "events"

# Plugin configuration
plugins:
  # Auto-load plugins from directory
  auto_load:
    enabled: false
    directory: "./plugins"
  # Plugin timeout (ms)
  timeout: 5000

# Security configuration
security:
  # Enable security headers
  headers:
    enabled: true
    hsts: true
    no_sniff: true
    xss_protection: true
    frame_guard: true
  # CORS configuration
  cors:
    enabled: true
    origins:
      - "*"
    methods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
      - "PATCH"
    headers:
      - "Content-Type"
      - "Authorization"
  # Rate limiting
  rate_limit:
    enabled: true
    max_requests: 100
    window_ms: 60000  # 1 minute

# Monitoring configuration
monitoring:
  # Enable metrics collection
  metrics:
    enabled: true
    endpoint: "/metrics"
  # Health check
  health_check:
    enabled: true
    endpoint: "/health"
  # Request logging
  request_logging:
    enabled: true
    include_body: false
    include_headers: false

# Cache configuration
cache:
  # Enable response caching
  enabled: false
  # Cache TTL (seconds)
  ttl: 300
  # Maximum cache size (entries)
  max_size: 1000
  # Cache storage
  storage: "memory"  # or "redis"

# Environment-specific overrides
environments:
  development:
    logging:
      level: "debug"
      pretty: true
    development:
      hot_reload:
        enabled: true

  staging:
    logging:
      level: "info"
    optimization:
      level: "O2"

  production:
    logging:
      level: "warn"
      pretty: false
    optimization:
      level: "O3"
    security:
      headers:
        enabled: true
    monitoring:
      metrics:
        enabled: true

# Feature flags
features:
  # Enable experimental features
  experimental:
    enabled: false
  # Enable polyglot schema validation
  polyglot_validation: true
  # Enable native compilation
  native_compilation: true
  # Enable async hooks
  async_hooks: true

# Performance tuning
performance:
  # GC tuning
  gc:
    # GC algorithm: serial, parallel, G1, ZGC
    algorithm: "G1"
    # Max heap size (MB)
    max_heap: 512
    # Initial heap size (MB)
    initial_heap: 128

  # Thread pool size
  thread_pool:
    min: 4
    max: 32

  # Connection pool
  connection_pool:
    max_connections: 1000
    connection_timeout: 5000

# Metadata
metadata:
  tags:
    - "web-framework"
    - "fastify"
    - "high-performance"
    - "polyglot"
  maintainer: "Elide Team"
  documentation: "https://github.com/elide-dev/showcases/tree/main/converted/tier1-frameworks/fastify"
