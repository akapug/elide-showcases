# Vulnerability Scanner Service

Enterprise-grade security vulnerability scanner with dependency scanning, CVE matching, risk scoring, patch recommendations, and comprehensive security reporting.

## Features

### Dependency Scanning
- Multi-ecosystem support (npm, PyPI, Maven, NuGet, Go, Cargo, Composer)
- Deep dependency tree analysis
- License compliance checking
- Deprecated package detection
- Version conflict resolution

### CVE Matching
- Integration with National Vulnerability Database (NVD)
- GitHub Security Advisories
- Vendor-specific vulnerability databases
- Real-time CVE updates
- Historical vulnerability tracking

### Risk Scoring
- CVSS 3.1 base score calculation
- Exploitability metrics
- Production impact assessment
- Custom risk weighting
- Trending vulnerability analysis

### Patch Recommendations
- Automated upgrade path analysis
- Breaking change detection
- Dependency conflict resolution
- Workaround suggestions
- Priority-based remediation planning

### Report Generation
- Executive summaries
- Detailed technical reports
- Compliance reports (OWASP, NIST)
- Trend analysis
- Export formats (JSON, PDF, CSV, HTML)

## API Endpoints

### POST /api/scans
Create a new vulnerability scan.

**Request:**
```json
{
  "projectName": "my-web-app",
  "projectVersion": "2.5.0",
  "packages": [
    {
      "name": "express",
      "version": "4.17.1",
      "ecosystem": "npm",
      "license": "MIT"
    },
    {
      "name": "lodash",
      "version": "4.17.20",
      "ecosystem": "npm",
      "license": "MIT"
    },
    {
      "name": "axios",
      "version": "0.21.0",
      "ecosystem": "npm",
      "license": "MIT"
    }
  ]
}
```

**Response:**
```json
{
  "scan": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "projectName": "my-web-app",
    "projectVersion": "2.5.0",
    "status": "pending",
    "createdAt": "2025-11-07T10:30:00.000Z"
  }
}
```

### GET /api/scans/:id
Get scan status and metadata.

**Response:**
```json
{
  "scan": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "projectName": "my-web-app",
    "projectVersion": "2.5.0",
    "status": "completed",
    "createdAt": "2025-11-07T10:30:00.000Z",
    "completedAt": "2025-11-07T10:30:45.000Z"
  }
}
```

### GET /api/results/:scanId
Get detailed scan results.

**Response:**
```json
{
  "result": {
    "id": "650e8400-e29b-41d4-a716-446655440001",
    "scanId": "550e8400-e29b-41d4-a716-446655440000",
    "projectName": "my-web-app",
    "projectVersion": "2.5.0",
    "scannedAt": "2025-11-07T10:30:45.000Z",
    "statistics": {
      "totalPackages": 150,
      "vulnerablePackages": 8,
      "totalVulnerabilities": 12,
      "bySeverity": {
        "critical": 2,
        "high": 4,
        "medium": 5,
        "low": 1,
        "info": 0
      },
      "byStatus": {
        "open": 10,
        "fixed": 2,
        "mitigated": 0,
        "accepted": 0,
        "false_positive": 0
      }
    },
    "riskScore": 75,
    "recommendations": [
      "URGENT: Address 2 critical vulnerabilities immediately",
      "High priority: Fix 4 high-severity vulnerabilities",
      "5 vulnerabilities have known public exploits - prioritize these"
    ],
    "vulnerabilities": [...]
  }
}
```

### GET /api/vulnerabilities
Retrieve vulnerabilities with filtering.

**Query Parameters:**
- `severity`: Filter by severity (critical, high, medium, low, info)
- `status`: Filter by status (open, fixed, mitigated, accepted, false_positive)
- `package`: Filter by package name

**Response:**
```json
{
  "vulnerabilities": [
    {
      "id": "750e8400-e29b-41d4-a716-446655440002",
      "package": {
        "name": "lodash",
        "version": "4.17.20",
        "ecosystem": "npm"
      },
      "cve": {
        "id": "CVE-2021-23337",
        "publishedDate": "2021-02-15T00:00:00.000Z",
        "description": "Command injection vulnerability in lodash template function",
        "severity": "high",
        "cvssScore": 7.2,
        "cvssVector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H",
        "cweIds": ["CWE-78", "CWE-94"],
        "references": [
          "https://nvd.nist.gov/vuln/detail/CVE-2021-23337",
          "https://snyk.io/vuln/SNYK-JS-LODASH-1040724"
        ],
        "affectedVersions": ["<4.17.21"],
        "patchedVersions": ["4.17.21"]
      },
      "detectedAt": "2025-11-07T10:30:45.000Z",
      "status": "open",
      "riskScore": 85,
      "exploitAvailable": true,
      "inProduction": true,
      "remediation": {
        "recommendation": "Upgrade lodash to version 4.17.21 or later",
        "patchVersion": "4.17.21",
        "priority": "high",
        "effort": "low",
        "breakingChange": false
      }
    }
  ],
  "count": 1
}
```

### PATCH /api/vulnerabilities/:id
Update vulnerability status.

**Request:**
```json
{
  "status": "fixed"
}
```

**Response:**
```json
{
  "success": true
}
```

### GET /api/reports/security
Generate comprehensive security report.

**Response:**
```json
{
  "report": {
    "id": "850e8400-e29b-41d4-a716-446655440003",
    "generatedAt": "2025-11-07T10:35:00.000Z",
    "summary": {
      "totalProjects": 5,
      "totalScans": 25,
      "totalVulnerabilities": 42,
      "criticalVulnerabilities": 5,
      "highVulnerabilities": 12,
      "averageRiskScore": 68
    },
    "trends": {
      "period": "Last 7 days",
      "newVulnerabilities": 8,
      "fixedVulnerabilities": 15,
      "riskScoreChange": -5
    },
    "topVulnerabilities": [...],
    "topRiskyPackages": [
      {
        "package": {
          "name": "lodash",
          "version": "4.17.20",
          "ecosystem": "npm"
        },
        "vulnerabilityCount": 3
      }
    ]
  }
}
```

## Usage

### Starting the Service

```bash
bun run server.ts
```

The service will start on `http://localhost:3002`.

### Scanning a Project

```bash
curl -X POST http://localhost:3002/api/scans \
  -H "Content-Type: application/json" \
  -d '{
    "projectName": "my-app",
    "projectVersion": "1.0.0",
    "packages": [
      {
        "name": "express",
        "version": "4.17.1",
        "ecosystem": "npm"
      },
      {
        "name": "lodash",
        "version": "4.17.20",
        "ecosystem": "npm"
      }
    ]
  }'
```

### Checking Scan Status

```bash
# Get scan status
SCAN_ID="550e8400-e29b-41d4-a716-446655440000"
curl http://localhost:3002/api/scans/$SCAN_ID
```

### Viewing Results

```bash
# Get detailed results
curl http://localhost:3002/api/results/$SCAN_ID

# Filter critical vulnerabilities
curl "http://localhost:3002/api/vulnerabilities?severity=critical&status=open"

# Find vulnerabilities in specific package
curl "http://localhost:3002/api/vulnerabilities?package=lodash"
```

### Generating Reports

```bash
curl http://localhost:3002/api/reports/security > security-report.json
```

## CVE Database

The service includes mock CVE data for demonstration. In production, integrate with:

- **National Vulnerability Database (NVD)**: Official U.S. government repository
- **GitHub Advisory Database**: Community-driven security advisories
- **Snyk Vulnerability DB**: Commercial vulnerability intelligence
- **OSV (Open Source Vulnerabilities)**: Google's vulnerability database
- **CVE Program**: MITRE's CVE identification system

## Risk Scoring Algorithm

Risk scores (0-100) are calculated using:

1. **Base Score**: CVSS 3.1 score (0-10) × 10
2. **Severity Multiplier**:
   - Critical: 1.5×
   - High: 1.3×
   - Medium: 1.1×
   - Low: 0.9×
   - Info: 0.5×
3. **Exploit Factor**: +20 if public exploit available
4. **Production Factor**: +15 if package used in production

Overall project risk considers:
- Average vulnerability risk score
- Critical vulnerability count (+10 per critical)
- High vulnerability count (+5 per high)

## Architecture

### Components

1. **Scanner Engine**: Orchestrates scanning process
2. **CVE Database**: Vulnerability data storage and retrieval
3. **Risk Calculator**: Computes risk scores and priorities
4. **Remediation Engine**: Generates patch recommendations
5. **Report Generator**: Creates security reports

### Scanning Process

1. Parse project dependencies
2. Query CVE database for each package
3. Match versions against affected ranges
4. Calculate risk scores
5. Generate remediation recommendations
6. Create scan results and reports

## Integration

### CI/CD Pipeline

```yaml
# GitHub Actions example
- name: Security Scan
  run: |
    # Generate package list from package.json
    PACKAGES=$(jq -r '.dependencies | to_entries | map({name: .key, version: .value, ecosystem: "npm"})' package.json)

    # Submit scan
    SCAN_ID=$(curl -X POST http://vulnerability-scanner:3002/api/scans \
      -H "Content-Type: application/json" \
      -d "{\"projectName\": \"$CI_PROJECT_NAME\", \"projectVersion\": \"$CI_COMMIT_TAG\", \"packages\": $PACKAGES}" \
      | jq -r '.scan.id')

    # Wait for results and fail if critical vulnerabilities found
    sleep 10
    CRITICAL=$(curl http://vulnerability-scanner:3002/api/results/$SCAN_ID | jq '.result.statistics.bySeverity.critical')

    if [ "$CRITICAL" -gt 0 ]; then
      echo "Found $CRITICAL critical vulnerabilities"
      exit 1
    fi
```

### Automated Monitoring

```bash
# Schedule daily scans
0 2 * * * /usr/local/bin/scan-dependencies.sh

# Alert on new critical vulnerabilities
curl "http://localhost:3002/api/vulnerabilities?severity=critical&status=open" \
  | jq -r '.count' \
  | xargs -I {} [ {} -gt 0 ] && send-alert.sh
```

## Production Considerations

- Implement persistent storage for scan history (PostgreSQL, MongoDB)
- Cache CVE data and update periodically
- Add authentication and API rate limiting
- Scale horizontally for large-scale scanning
- Integrate with package managers (npm, pip, maven)
- Implement webhook notifications for new vulnerabilities
- Add SBOM (Software Bill of Materials) generation
- Support for container image scanning
- Integration with security information systems
- Automated PR generation for dependency updates

## Best Practices

1. **Regular Scanning**: Run scans on every commit and daily
2. **Critical Path**: Block deployments for critical vulnerabilities
3. **Dependency Hygiene**: Keep dependencies updated
4. **False Positive Management**: Review and mark false positives
5. **Remediation Tracking**: Monitor time-to-fix metrics
6. **Security Training**: Educate developers on secure dependencies
7. **Supply Chain Security**: Verify package signatures and integrity

## License

MIT
